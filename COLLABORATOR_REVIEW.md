# åä½œè€…æ›´æ”¹å®¡æŸ¥æŠ¥å‘Š

## åä½œè€…ä¿¡æ¯
- **ä½œè€…**: lzy (zhiyangliu884@gmail.com)
- **æœ€æ–°æäº¤**: 7c7770c - "lzy change 2026-2-17" (2026-02-17 09:40:34 +0800)
- **åˆ†æ”¯**: origin/lzy-change
- **å®¡æŸ¥èŒƒå›´**: 2æœˆ17æ—¥æäº¤ + ä¹‹å‰çš„æ›´æ”¹ï¼ˆ2æœˆ15æ—¥ã€2æœˆ14æ—¥ç­‰ï¼‰

## 2æœˆ17æ—¥æ›´æ–°è¯¦æƒ…

### æœ¬æ¬¡æäº¤ï¼ˆ7c7770cï¼‰çš„æ›´æ”¹
1. **æ·»åŠ æµ‹è¯•æ–‡ä»¶**: `tests/unit/test_converter_pipeline.py` (85è¡Œ)
   - æµ‹è¯• `PDFConverter` çš„åŸºæœ¬è½¬æ¢åŠŸèƒ½
   - æµ‹è¯• fast modeï¼ˆæ— LLMï¼‰è½¬æ¢
   - æµ‹è¯•é”™è¯¯å¤„ç†ï¼ˆç¼ºå¤±æ–‡ä»¶ï¼‰
   - **å…¼å®¹æ€§**: âœ… **å®Œå…¨å…¼å®¹** - ä½¿ç”¨ `ConvertConfig` å’Œ `PDFConverter`ï¼Œä¸Žæœ¬åœ°ä»£ç ä¸€è‡´

2. **æ·»åŠ è°ƒè¯•æ—¥å¿—æ–‡ä»¶**ï¼ˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåº”è¯¥è¢« .gitignoreï¼‰:
   - `debug_flush.txt`
   - `debug_pipeline.log`
   - `import_log.txt`
   - `simple_log.txt`
   - `test_output.txt`
   - **å»ºè®®**: è¿™äº›æ–‡ä»¶åº”è¯¥æ·»åŠ åˆ° `.gitignore`ï¼Œä¸åº”è¯¥æäº¤åˆ°ä»“åº“

### ä¹‹å‰æäº¤çš„æ›´æ”¹ï¼ˆ2æœˆ15æ—¥ã€2æœˆ14æ—¥ç­‰ï¼‰

## æ›´æ”¹æ‘˜è¦

### ä¸»è¦æ›´æ”¹
1. **é…ç½®ç±»é‡å‘½å**: `ConverterConfig` â†’ `ConvertConfig`
   - å½±å“æ–‡ä»¶: `kb/converter/llm_worker.py`, `kb/converter/pipeline.py`, `kb/converter/__init__.py`
   - **å…¼å®¹æ€§**: âœ… **å·²å…¼å®¹** - æœ¬åœ°ä»£ç å·²ä½¿ç”¨ `ConvertConfig`

2. **åˆ é™¤ test2.py**: åˆ é™¤äº† 6790 è¡Œä»£ç 
   - **å½±å“**: è¿™æ˜¯ä¸€ä¸ªå¤§çš„æ¸…ç†æ“ä½œ
   - **å…¼å®¹æ€§**: âš ï¸ **éœ€è¦æ³¨æ„** - å¦‚æžœå…¶ä»–åœ°æ–¹å¼•ç”¨äº† test2.pyï¼Œéœ€è¦æ›´æ–°

3. **æ·»åŠ æµ‹è¯•æ–‡ä»¶**:
   - `tests/__init__.py`
   - `tests/conftest.py`
   - `tests/sanity/test_app_startup.py`
   - `tests/unit/test_chunking.py`
   - `tests/unit/test_converter_pipeline.py`
   - `tests/unit/test_text_utils.py`
   - **å…¼å®¹æ€§**: âœ… **å…¼å®¹** - æ–°å¢žæ–‡ä»¶ï¼Œä¸å½±å“çŽ°æœ‰ä»£ç 

4. **ä»£ç ç®€åŒ–**:
   - `kb/converter/pipeline.py`: åˆ é™¤äº† 4082 è¡Œï¼ˆå¤§é‡æ—§ä»£ç ï¼‰
   - `kb/converter/llm_worker.py`: åˆ é™¤äº† 520 è¡Œ
   - **å…¼å®¹æ€§**: âš ï¸ **éœ€è¦æ£€æŸ¥** - ç¡®ä¿åˆ é™¤çš„ä»£ç ä¸æ˜¯å¿…éœ€çš„

5. **åŠŸèƒ½å¢žå¼º**:
   - `kb/chunking.py`: æ”¹è¿›äº† `flush_buf()` è°ƒç”¨é€»è¾‘
   - `kb/converter/text_utils.py`: æ·»åŠ äº† `_common_prefix_length()` å‡½æ•°
   - **å…¼å®¹æ€§**: âœ… **å…¼å®¹** - æœ¬åœ°ä»£ç å·²åŒ…å«è¿™äº›æ›´æ”¹

## è¯¦ç»†æ›´æ”¹åˆ†æž

### 1. é…ç½®ç±»é‡å‘½å (`ConverterConfig` â†’ `ConvertConfig`)

**æ›´æ”¹æ–‡ä»¶**:
- `kb/converter/llm_worker.py`: `from .config import ConverterConfig` â†’ `from .config import ConvertConfig`
- `kb/converter/pipeline.py`: `from .config import ConverterConfig` â†’ `from .config import ConvertConfig`
- `kb/converter/__init__.py`: å¯¼å‡º `ConvertConfig` è€Œä¸æ˜¯ `ConverterConfig`

**æœ¬åœ°çŠ¶æ€**: âœ… æœ¬åœ°ä»£ç å·²ä½¿ç”¨ `ConvertConfig`ï¼Œå®Œå…¨å…¼å®¹

### 2. test2.py åˆ é™¤ âš ï¸ **å…³é”®å†²çª**

**å½±å“**: 
- åˆ é™¤äº† 6790 è¡Œçš„ `test2.py` æ–‡ä»¶
- è¿™æ˜¯ä¸€ä¸ªå¤§çš„æ¸…ç†æ“ä½œ

**âš ï¸ å‘çŽ°çš„å¼•ç”¨**:
- âŒ `kb/pdf_tools.py:957-959`: ä½¿ç”¨ `test2.py` ä½œä¸ºè½¬æ¢å™¨çš„ fallback
  ```python
  local_script = Path(__file__).resolve().parents[1] / "test2.py"
  legacy_script = Path(__file__).resolve().parents[2] / "test2.py"
  script = local_script if local_script.exists() else legacy_script
  ```
- âŒ `app.py:115-117`: è®¾ç½®çŽ¯å¢ƒå˜é‡æŒ‡å‘ `test2.py`
  ```python
  _LOCAL_CONVERTER = Path(__file__).resolve().parent / "test2.py"
  if _LOCAL_CONVERTER.exists():
      os.environ["KB_PDF_CONVERTER"] = str(_LOCAL_CONVERTER)
  ```
- âš ï¸ `kb/converter/pipeline.py:170`: æ³¨é‡Šä¸­æåˆ° `test2.py`
- âš ï¸ `kb/converter/post_processing.py:151`: æ³¨é‡Šä¸­æåˆ° `test2.py`
- âš ï¸ `README.md:86`: æ–‡æ¡£ä¸­æåˆ° `test2.py`

**å†²çªåˆ†æž**:
- ðŸ”´ **ä¸¥é‡å†²çª**: `kb/pdf_tools.py` å’Œ `app.py` ä»ç„¶ä¾èµ– `test2.py` ä½œä¸ºè½¬æ¢å™¨
- å¦‚æžœåˆå¹¶åä½œè€…çš„æ›´æ”¹ï¼Œè¿™äº›æ–‡ä»¶ä¼šæ‰¾ä¸åˆ° `test2.py`ï¼Œå¯¼è‡´è½¬æ¢åŠŸèƒ½å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
1. **æ–¹æ¡ˆAï¼ˆæŽ¨èï¼‰**: åœ¨åˆå¹¶å‰ï¼Œå°† `kb/pdf_tools.py` å’Œ `app.py` æ”¹ä¸ºä½¿ç”¨æ–°çš„ `kb/converter` æ¨¡å—
2. **æ–¹æ¡ˆB**: ä¿ç•™ `test2.py` ä½œä¸ºå…¼å®¹å±‚ï¼Œä½†æ ‡è®°ä¸º deprecated
3. **æ–¹æ¡ˆC**: æš‚æ—¶ä¸åˆå¹¶ `test2.py` çš„åˆ é™¤ï¼Œå…ˆè¿ç§»å¼•ç”¨

### 3. æµ‹è¯•æ–‡ä»¶æ·»åŠ 

**æ–°å¢žæ–‡ä»¶**:
```
tests/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ conftest.py
â”œâ”€â”€ sanity/
â”‚   â””â”€â”€ test_app_startup.py
â””â”€â”€ unit/
    â”œâ”€â”€ test_chunking.py
    â”œâ”€â”€ test_converter_pipeline.py
    â””â”€â”€ test_text_utils.py
```

**å…¼å®¹æ€§**: âœ… å®Œå…¨å…¼å®¹ï¼Œæ–°å¢žæ–‡ä»¶ä¸å½±å“çŽ°æœ‰ä»£ç 

### 4. ä»£ç ç®€åŒ–

**pipeline.py å¤§å¹…ç®€åŒ–**:
- åˆ é™¤äº†å¤§é‡æ—§çš„å¤„ç†é€»è¾‘
- å¯èƒ½ç§»é™¤äº†ä¸å†ä½¿ç”¨çš„å‡½æ•°

**éœ€è¦æ£€æŸ¥**:
- [ ] ç¡®è®¤åˆ é™¤çš„ä»£ç æ˜¯å¦ä»è¢«ä½¿ç”¨
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰åŠŸèƒ½ä¾èµ–è¢«åˆ é™¤çš„ä»£ç 

**llm_worker.py ç®€åŒ–**:
- åˆ é™¤äº† 520 è¡Œä»£ç 
- å¯èƒ½ç§»é™¤äº†ä¸å†ä½¿ç”¨çš„ LLM è°ƒç”¨æ–¹æ³•

### 5. åŠŸèƒ½å¢žå¼º

**chunking.py**:
```python
# åä½œè€…çš„æ›´æ”¹
if m_page:
    flush_buf()  # æ·»åŠ äº† flush_buf() è°ƒç”¨
    ...

if stripped == "":
    flush_buf()  # æ”¹ä¸º flush_buf() è€Œä¸æ˜¯ buf.append("")
```

**æœ¬åœ°çŠ¶æ€**: âœ… æœ¬åœ°ä»£ç å·²åŒ…å«è¿™äº›æ›´æ”¹

**text_utils.py**:
```python
# åä½œè€…æ·»åŠ çš„å‡½æ•°
def _common_prefix_length(s1: str, s2: str) -> int:
    i = 0
    while i < min(len(s1), len(s2)) and s1[i] == s2[i]:
        i += 1
    return i
```

**æœ¬åœ°çŠ¶æ€**: âœ… æœ¬åœ°ä»£ç å·²åŒ…å«è¿™ä¸ªå‡½æ•°

## å†²çªæ£€æŸ¥

### Git åˆå¹¶æµ‹è¯•
- **ç»“æžœ**: âœ… **æ— å†²çª**
- åä½œè€…çš„æ›´æ”¹ä¸Žæœ¬åœ°æ›´æ”¹åœ¨å¤§éƒ¨åˆ†æ–‡ä»¶ä¸Šå…¼å®¹

### æ½œåœ¨é—®é¢˜

1. **pipeline.py å¤§é‡åˆ é™¤**:
   - åä½œè€…åˆ é™¤äº† 4082 è¡Œä»£ç 
   - æœ¬åœ°ä»£ç å¯èƒ½ä¾èµ–æŸäº›è¢«åˆ é™¤çš„åŠŸèƒ½
   - **å»ºè®®**: ä»”ç»†æ£€æŸ¥åˆ é™¤çš„ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰åŠŸèƒ½ä¸¢å¤±

2. **llm_worker.py ç®€åŒ–**:
   - åˆ é™¤äº† 520 è¡Œä»£ç 
   - å¯èƒ½ç§»é™¤äº†æŸäº› LLM è°ƒç”¨æ–¹æ³•
   - **å»ºè®®**: ç¡®è®¤åˆ é™¤çš„æ–¹æ³•æ˜¯å¦ä»è¢«ä½¿ç”¨

3. **test2.py åˆ é™¤**:
   - å¦‚æžœå…¶ä»–åœ°æ–¹å¼•ç”¨äº†è¿™ä¸ªæ–‡ä»¶ï¼Œéœ€è¦æ›´æ–°
   - **å»ºè®®**: æœç´¢ä»£ç åº“ä¸­æ˜¯å¦æœ‰å¯¹ `test2.py` çš„å¼•ç”¨

## å…¼å®¹æ€§æ€»ç»“

| æ›´æ”¹é¡¹ | å…¼å®¹æ€§ | è¯´æ˜Ž |
|--------|--------|------|
| `ConverterConfig` â†’ `ConvertConfig` | âœ… å·²å…¼å®¹ | æœ¬åœ°ä»£ç å·²ä½¿ç”¨æ–°åç§° |
| `test2.py` åˆ é™¤ | ðŸ”´ **å†²çª** | `kb/pdf_tools.py` å’Œ `app.py` ä»ä¾èµ–å®ƒ |
| æµ‹è¯•æ–‡ä»¶æ·»åŠ  | âœ… å…¼å®¹ | æ–°å¢žæ–‡ä»¶ï¼Œä¸å½±å“çŽ°æœ‰ä»£ç  |
| `pipeline.py` ç®€åŒ– | âš ï¸ éœ€æ£€æŸ¥ | å¤§é‡ä»£ç åˆ é™¤ï¼Œéœ€ç¡®è®¤åŠŸèƒ½å®Œæ•´æ€§ |
| `llm_worker.py` ç®€åŒ– | âš ï¸ éœ€æ£€æŸ¥ | å¤§é‡ä»£ç åˆ é™¤ï¼Œéœ€ç¡®è®¤åŠŸèƒ½å®Œæ•´æ€§ |
| `chunking.py` æ”¹è¿› | âœ… å·²åŒ…å« | æœ¬åœ°ä»£ç å·²åŒ…å«è¿™äº›æ›´æ”¹ |
| `text_utils.py` å¢žå¼º | âœ… å·²åŒ…å« | æœ¬åœ°ä»£ç å·²åŒ…å«è¿™äº›æ›´æ”¹ |

## å»ºè®®æ“ä½œ

### 1. ç«‹å³å¯ä»¥åˆå¹¶çš„æ›´æ”¹
- âœ… `ConverterConfig` â†’ `ConvertConfig` é‡å‘½åï¼ˆå·²å…¼å®¹ï¼‰
- âœ… æµ‹è¯•æ–‡ä»¶æ·»åŠ ï¼ˆå®Œå…¨å…¼å®¹ï¼‰
- âœ… `chunking.py` å’Œ `text_utils.py` çš„æ”¹è¿›ï¼ˆå·²åŒ…å«ï¼‰

### 2. éœ€è¦å®¡æŸ¥çš„æ›´æ”¹
- âš ï¸ `pipeline.py` å¤§é‡ä»£ç åˆ é™¤ - éœ€è¦ç¡®è®¤åŠŸèƒ½å®Œæ•´æ€§
- âš ï¸ `llm_worker.py` ä»£ç ç®€åŒ– - éœ€è¦ç¡®è®¤åŠŸèƒ½å®Œæ•´æ€§
- âš ï¸ `test2.py` åˆ é™¤ - éœ€è¦ç¡®è®¤æ˜¯å¦æœ‰å¼•ç”¨

### 3. åˆå¹¶å‰æ£€æŸ¥æ¸…å•
- [ ] æœç´¢ä»£ç åº“ä¸­æ˜¯å¦æœ‰å¯¹ `test2.py` çš„å¼•ç”¨
- [ ] æ£€æŸ¥ `pipeline.py` åˆ é™¤çš„ä»£ç æ˜¯å¦ä»è¢«ä½¿ç”¨
- [ ] æ£€æŸ¥ `llm_worker.py` åˆ é™¤çš„æ–¹æ³•æ˜¯å¦ä»è¢«è°ƒç”¨
- [ ] è¿è¡Œæµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸
- [ ] æ£€æŸ¥ CI/CD æµç¨‹æ˜¯å¦ä¾èµ– `test2.py`

## åˆå¹¶å»ºè®®

**æŽ¨èæ“ä½œ**:
1. å…ˆåˆå¹¶å…¼å®¹çš„æ›´æ”¹ï¼ˆé…ç½®é‡å‘½åã€æµ‹è¯•æ–‡ä»¶ã€å°æ”¹è¿›ï¼‰
2. ä»”ç»†å®¡æŸ¥ `pipeline.py` å’Œ `llm_worker.py` çš„åˆ é™¤å†…å®¹
3. ç¡®è®¤ `test2.py` åˆ é™¤ä¸ä¼šå½±å“å…¶ä»–åŠŸèƒ½
4. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
5. å¦‚æžœä¸€åˆ‡æ­£å¸¸ï¼Œå¯ä»¥åˆå¹¶æ‰€æœ‰æ›´æ”¹

**é£Žé™©è¯„ä¼°**: ðŸ”´ **é«˜é£Žé™©**
- **å…³é”®å†²çª**: `test2.py` åˆ é™¤ä¼šå¯¼è‡´ `kb/pdf_tools.py` å’Œ `app.py` çš„è½¬æ¢åŠŸèƒ½å¤±è´¥
- ä¸»è¦é£Žé™©æ¥è‡ªå¤§é‡ä»£ç åˆ é™¤
- éœ€è¦ä»”ç»†å®¡æŸ¥ç¡®ä¿åŠŸèƒ½å®Œæ•´æ€§

## âœ… å·²æŽ¥å—çš„æ“ä½œ

æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼Œ**åªæŽ¥å—æµ‹è¯•æ–‡ä»¶çš„æ›´æ”¹**ï¼Œä¿ç•™çŽ°æœ‰ä»£ç ï¼š

1. âœ… **å·²æ·»åŠ **: `tests/unit/test_converter_pipeline.py` - åä½œè€…2æœˆ17æ—¥æ–°å¢žçš„æµ‹è¯•æ–‡ä»¶
2. âŒ **ä¸åˆå¹¶**: `test2.py` åˆ é™¤ - ä¿ç•™çŽ°æœ‰æ–‡ä»¶
3. âŒ **ä¸åˆå¹¶**: `pipeline.py` å’Œ `llm_worker.py` çš„å¤§é‡åˆ é™¤ - ä¿ç•™çŽ°æœ‰ä»£ç 
4. âŒ **ä¸åˆå¹¶**: å…¶ä»–å¯èƒ½å†²çªçš„æ›´æ”¹ - å°Šé‡çŽ°æœ‰ç‰ˆæœ¬

**åŽŸå› **: è¿™äº›å†²çªå¯èƒ½æ˜¯ç”±äºŽç‰ˆæœ¬ä¸ä¸€è‡´å¯¼è‡´çš„ï¼Œç”¨æˆ·é€‰æ‹©å°Šé‡çŽ°æœ‰ä»£ç ã€‚

## âš ï¸ å…³é”®å†²çªè¯¦æƒ…

### test2.py åˆ é™¤å†²çª

**é—®é¢˜**: åä½œè€…åˆ é™¤äº† `test2.py`ï¼Œä½†ä»¥ä¸‹æ–‡ä»¶ä»åœ¨ä½¿ç”¨å®ƒï¼š

1. **`kb/pdf_tools.py`** (ç¬¬957-959è¡Œ):
   ```python
   local_script = Path(__file__).resolve().parents[1] / "test2.py"
   legacy_script = Path(__file__).resolve().parents[2] / "test2.py"
   script = local_script if local_script.exists() else legacy_script
   ```
   - å¦‚æžœ `test2.py` ä¸å­˜åœ¨ï¼Œä¼šå›žé€€åˆ° `_fallback_convert()`ï¼ŒåŠŸèƒ½å—é™

2. **`app.py`** (ç¬¬115-117è¡Œ):
   ```python
   _LOCAL_CONVERTER = Path(__file__).resolve().parent / "test2.py"
   if _LOCAL_CONVERTER.exists():
       os.environ["KB_PDF_CONVERTER"] = str(_LOCAL_CONVERTER)
   ```
   - å¦‚æžœ `test2.py` ä¸å­˜åœ¨ï¼ŒçŽ¯å¢ƒå˜é‡ä¸ä¼šè¢«è®¾ç½®

**å½±å“**: 
- ðŸ”´ **è½¬æ¢åŠŸèƒ½ä¼šå¤±è´¥æˆ–é™çº§** - å¦‚æžœ `test2.py` ä¸å­˜åœ¨ï¼Œ`kb/pdf_tools.py` ä¼šä½¿ç”¨åŸºç¡€çš„ fallback è½¬æ¢å™¨ï¼ŒåŠŸèƒ½å—é™

**å¿…é¡»çš„ä¿®å¤**:
åœ¨åˆå¹¶åä½œè€…çš„æ›´æ”¹å‰ï¼Œéœ€è¦ï¼š
1. ä¿®æ”¹ `kb/pdf_tools.py` ä½¿ç”¨æ–°çš„ `kb/converter` æ¨¡å—è€Œä¸æ˜¯ `test2.py`
2. ä¿®æ”¹ `app.py` ç§»é™¤å¯¹ `test2.py` çš„ä¾èµ–
3. æ›´æ–° `README.md` ä¸­çš„æ–‡æ¡£è¯´æ˜Ž

## 2æœˆ17æ—¥æ›´æ–°è¯¦ç»†åˆ†æž

### æ–°å¢žæµ‹è¯•æ–‡ä»¶å…¼å®¹æ€§æ£€æŸ¥

**æ–‡ä»¶**: `tests/unit/test_converter_pipeline.py`

**æµ‹è¯•å†…å®¹**:
1. `test_convert_pipeline_fast_mode`: æµ‹è¯•æ— LLMæ¨¡å¼çš„åŸºæœ¬è½¬æ¢
2. `test_convert_pipeline_missing_file`: æµ‹è¯•é”™è¯¯å¤„ç†

**å…¼å®¹æ€§æ£€æŸ¥**:
- âœ… ä½¿ç”¨ `ConvertConfig` - æœ¬åœ°ä»£ç å·²ä½¿ç”¨
- âœ… ä½¿ç”¨ `PDFConverter` - æœ¬åœ°ä»£ç å­˜åœ¨
- âœ… è°ƒç”¨ `converter.convert(pdf_path, save_dir)` - æ–¹æ³•ç­¾ååŒ¹é…
- âœ… æ£€æŸ¥ `output.md` æ–‡ä»¶ - æœ¬åœ°ä»£ç ç”Ÿæˆæ­¤æ–‡ä»¶
- âœ… æ£€æŸ¥ `assets` ç›®å½• - æœ¬åœ°ä»£ç åˆ›å»ºæ­¤ç›®å½•

**ç»“è®º**: âœ… **å®Œå…¨å…¼å®¹** - æµ‹è¯•æ–‡ä»¶å¯ä»¥ç›´æŽ¥ä½¿ç”¨

### è°ƒè¯•æ—¥å¿—æ–‡ä»¶

**é—®é¢˜**: åä½œè€…æäº¤äº†ä»¥ä¸‹è°ƒè¯•æ—¥å¿—æ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶ï¼‰:
- `debug_flush.txt`
- `debug_pipeline.log`
- `import_log.txt`
- `simple_log.txt`
- `test_output.txt`

**å»ºè®®**: 
- âš ï¸ è¿™äº›æ–‡ä»¶åº”è¯¥è¢« `.gitignore` å¿½ç•¥
- å»ºè®®åœ¨åˆå¹¶å‰æ¸…ç†è¿™äº›æ–‡ä»¶ï¼Œæˆ–æ›´æ–° `.gitignore` è§„åˆ™
